name: Nightly Release

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    permissions:
      contents: write 

    steps:
    - uses: actions/create-github-app-token@v1
      id: app-token
      with:
        app-id: 903565
        private-key: ${{ secrets.APP_PRIVATE_KEY }}

    - name: Install GitHub CLI
      run: sudo apt-get install gh

    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    - name: Fetch Dev Branch
      run: git fetch origin dev

    - name: Merge Dev into Release
          run: |
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git checkout release
            git merge origin/dev --no-ff -m "Nightly merge from dev to release"
            git push origin release
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            GH_TOKEN: ${{ steps.app-token.outputs.token }}